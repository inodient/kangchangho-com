module.exports.walkSync = walkSync;
module.exports.validation = validation;




function walkSync(dir, filelist) {
    var path = path || require('path');
    var fs = fs || require('fs'),
        files = fs.readdirSync(dir);
    filelist = filelist || [];
    files.forEach(function(file) {
        if (fs.statSync(path.join(dir, file)).isDirectory()) {
            filelist = walkSync(path.join(dir, file), filelist);
        }
        else {
        	var fileTermList = file.split(".");
        	var expansion = fileTermList[ fileTermList.length - 1 ];

        	if( expansion === "js" ){
        		filelist.push(path.join(dir, file));
        	}
        }
    });

    return filelist;
};


function validation( fileList ){
    const vm = require("vm");

    for( var i=0; i<fileList.length; i++ ){
        try {
            var scriptString = ( require("fs").readFileSync( fileList[i] ) ).toString();

            new vm.Script( scriptString );
        } catch( err ){
            var script = scriptString.split("\n");

            console.log( "\x1b[31m%s\x1b[0m", "[Validation Failed]", "===== CODE START =====" );
            console.log( "\n" );

            for( var j=0; j<script.length; j++ ){
                if( script[j] != "" ){
                    console.log( script[j].replace( /\/t/gi, " " ) );
                }
            }
            
            console.log( "\x1b[31m%s\x1b[0m", "[Validation Failed]", "===== CODE END =====" );
            console.log( "\n" );
            console.log( "\x1b[31m%s\x1b[0m", "[Validation Failed]", "In", fileList[i] );
            console.log( "\x1b[31m%s\x1b[0m", "[Validation Failed]", err.stack );
            return false;
        }
    }
    return true;
}


// function validation( fileList ){
//     var stackedy = require('stackedy');
//     var fs = require('fs');

//     for( var i=0; i<fileList.length; i++ ){
        
//         var src = fs.readFileSync(fileList[i]);
//         var fileName = (fileList[i]).split("/")[ (fileList[i]).split("/").length - 1 ];
//         var stack = stackedy(src, { filename : fileName }).run();

//         console.log( fileName );

//         stack.on('error', function (err, c) {
//             stack.stop();
//             console.log( c );
//             console.log('Error: ' + err);

//             // var cur = c.current;
//             // console.log('  -in ' + cur.filename + ' at line ' + cur.start.line);

//             // c.stack.forEach(function (s) {
//             //     console.log('  *in ' + s.filename + ', '
//             //         + s.functionName + '() at line ' + s.start.line
//             //     );
//             // });
//         });
//     }
// }